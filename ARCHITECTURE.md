# ì•„í‚¤í…ì²˜ ë¬¸ì„œ: 3-Service ë¶„ë¦¬

## ðŸ“Š í˜„ìž¬ êµ¬ì¡° (Before)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Railway Container (ë‹¨ì¼)         â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  Next.js     â”‚                       â”‚
â”‚  â”‚  (Port 3000) â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                               â”‚
â”‚         â”‚ spawn('python3', main.py)     â”‚
â”‚         â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Python       â”‚                       â”‚
â”‚  â”‚ CrewAI ì‹¤í–‰   â”‚                       â”‚
â”‚  â”‚              â”‚                       â”‚
â”‚  â”‚ - status.json íŒŒì¼ ì“°ê¸°                â”‚
â”‚  â”‚ - R2ì— ì—…ë¡œë“œ  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                         â”‚
â”‚  ë¬¸ì œì :                                  â”‚
â”‚  - Next.jsì™€ Pythonì´ ê°™ì€ ì»¨í…Œì´ë„ˆ          â”‚
â”‚  - ë¦¬ì†ŒìŠ¤ ê²½ìŸ (CPU/ë©”ëª¨ë¦¬)                  â”‚
â”‚  - í™•ìž¥ ë¶ˆê°€ëŠ¥ (ë‘˜ ë‹¤ í•¨ê»˜ ìŠ¤ì¼€ì¼)             â”‚
â”‚  - ìž¥ì•  ê²©ë¦¬ ë¶ˆê°€ (í•˜ë‚˜ ì£½ìœ¼ë©´ ì „ì²´)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í˜„ìž¬ íë¦„:
1. ì‚¬ìš©ìžê°€ "Generate" í´ë¦­
2. Next.js `/api/generate` â†’ `spawn('python3', main.py)` ì‹¤í–‰
3. Pythonì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ CrewAI ì‹¤í–‰
4. Pythonì´ `status.json` íŒŒì¼ì— ì§„í–‰ìƒí™© ê¸°ë¡
5. Next.jsê°€ `/api/status`ë¡œ í´ë§ (2ì´ˆë§ˆë‹¤)
6. ì™„ë£Œë˜ë©´ `/api/article`ë¡œ R2ì—ì„œ íŒŒì¼ ê°€ì ¸ì˜´

---

## ðŸŽ¯ ëª©í‘œ êµ¬ì¡° (After)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      HTTP       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚    API       â”‚
â”‚  (Next.js)   â”‚                 â”‚  (FastAPI)   â”‚
â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚ Port: 3000   â”‚      JSON       â”‚ Port: 8000   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ Redis Queue
                                         â”‚ (Job Enqueue)
                                         â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚   Worker     â”‚
                                  â”‚  (Python)    â”‚
                                  â”‚              â”‚
                                  â”‚ - CrewAI ì‹¤í–‰ â”‚ 
                                  â”‚ - R2 ì—…ë¡œë“œ    â”‚
                                  â”‚ - DB ì—…ë°ì´íŠ¸  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì„œë¹„ìŠ¤ ê°„ í†µì‹ :
- **Web â†’ API**: HTTP ìš”ì²­ (article ìƒì„±, job enqueue, job ìƒíƒœ ì¡°íšŒ)
- **API â†’ Redis**: Job enqueue (LPUSH)
- **Worker â†’ Redis**: Job consume (BRPOP)
- **Worker â†’ R2**: ê²°ê³¼ ì—…ë¡œë“œ
- **Worker â†’ Postgres**: Job ìƒíƒœ ì—…ë°ì´íŠ¸ (ì´ìŠˆ #8ì—ì„œ êµ¬í˜„)

### ìƒˆë¡œìš´ íë¦„:
1. ì‚¬ìš©ìžê°€ "Generate" í´ë¦­
2. Next.js â†’ FastAPI `POST /articles/:id/generate` í˜¸ì¶œ
3. FastAPIê°€ ì¦‰ì‹œ `jobId` ë°˜í™˜ (ë¹„ë™ê¸°)
4. FastAPIê°€ Redis íì— job enqueue
5. Workerê°€ Redis íì—ì„œ job consume
6. Workerê°€ CrewAI ì‹¤í–‰ ë° ê²°ê³¼ ì €ìž¥
7. Next.jsê°€ FastAPI `GET /jobs/:jobId`ë¡œ í´ë§
8. ì™„ë£Œë˜ë©´ `/api/article`ë¡œ ê²°ê³¼ ê°€ì ¸ì˜´

---

## ðŸ”‘ í•µì‹¬ ê°œë…

### 1. **ë¹„ë™ê¸° ìž‘ì—… ì²˜ë¦¬ (Async Job Processing)**
- **ë¬¸ì œ**: CrewAI ì‹¤í–‰ì€ 2-5ë¶„ ê±¸ë¦¼ â†’ HTTP ìš”ì²­ì´ íƒ€ìž„ì•„ì›ƒ
- **í•´ê²°**: Job Queue íŒ¨í„´
  - ìš”ì²­ ì¦‰ì‹œ `jobId` ë°˜í™˜
  - ì‹¤ì œ ìž‘ì—…ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬
  - í´ë¼ì´ì–¸íŠ¸ëŠ” job ìƒíƒœë¥¼ í´ë§

### 2. **ì„œë¹„ìŠ¤ ë¶„ë¦¬ (Service Separation)**
- **ì›ì¹™**: "í•œ ì»¨í…Œì´ë„ˆ = í•œ ì—­í• "
- **ìž¥ì **:
  - ë…ë¦½ì  ìŠ¤ì¼€ì¼ë§ (workerë§Œ ëŠ˜ë¦¬ë©´ ë¨)
  - ìž¥ì•  ê²©ë¦¬ (worker ì£½ì–´ë„ web/apiëŠ” ì •ìƒ)
  - ë°°í¬ ë¶„ë¦¬ (apië§Œ ìˆ˜ì •í•´ë„ worker ì˜í–¥ ì—†ìŒ)

### 3. **Job Queue (Redis)**
- **ì—­í• **: ìž‘ì—… ìš”ì²­ì„ íì— ë„£ê³ , workerê°€ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
- **ìƒíƒœ**: `queued` â†’ `running` â†’ `succeeded` / `failed`
- **ìž¥ì **: ë¶€í•˜ ë¶„ì‚°, ìž¬ì‹œë„ ê°€ëŠ¥, ìš°ì„ ìˆœìœ„ ì„¤ì • ê°€ëŠ¥

---

## ðŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
opad/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/              # API ì„œë¹„ìŠ¤ (FastAPI)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py       # FastAPI ì•± ì§„ìž…ì 
â”‚   â”‚   â”œâ”€â”€ models.py     # Pydantic ëª¨ë¸ (Article, Job)
â”‚   â”‚   â”œâ”€â”€ routes/       # API ì—”ë“œí¬ì¸íŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ articles.py
â”‚   â”‚   â”‚   â””â”€â”€ jobs.py
â”‚   â”‚   â””â”€â”€ queue.py      # Redis í ê´€ë¦¬
â”‚   â”‚
â”‚   â”œâ”€â”€ worker/           # Worker ì„œë¹„ìŠ¤ (Python)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py       # Worker ì§„ìž…ì 
â”‚   â”‚   â””â”€â”€ processor.py  # Job ì²˜ë¦¬ ë¡œì§
â”‚   â”‚
â”‚   â”œâ”€â”€ web/              # Web ì„œë¹„ìŠ¤ (Next.js)
â”‚   â”‚   â”œâ”€â”€ app/          # Next.js App Router
â”‚   â”‚   â”‚   â”œâ”€â”€ api/      # API Routes (í”„ë¡ì‹œ)
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx  # ë©”ì¸ íŽ˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ components/   # React ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ opad/             # CrewAI ë¡œì§ (ê³µìœ )
â”‚   â”‚   â”œâ”€â”€ crew.py
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”‚
â”‚   â””â”€â”€ utils/            # ê³µí†µ ìœ í‹¸ë¦¬í‹° (ê³µìœ )
â”‚       â”œâ”€â”€ cloudflare.py
â”‚       â””â”€â”€ progress.py
â”‚
â””â”€â”€ Dockerfile.*          # ì„œë¹„ìŠ¤ë³„ Dockerfile (ì´ìŠˆ #9)
```

### ì„œë¹„ìŠ¤ êµ¬ë¶„
| í´ë” | ì—­í•  | ëŸ°íƒ€ìž„ | í¬íŠ¸ |
|------|------|--------|------|
| `src/api/` | CRUD + Job enqueue | Python (FastAPI) | 8000 |
| `src/worker/` | CrewAI ì‹¤í–‰ | Python | - |
| `src/web/` | UI | Node.js (Next.js) | 3000 |
| `src/opad/` | CrewAI ë¡œì§ (ê³µìœ ) | - | - |
| `src/utils/` | ê³µí†µ ìœ í‹¸ (ê³µìœ ) | - | - |
