<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OPAD Hexagonal Architecture</title>
  <style>
    :root {
      --bg: #0f0f1a;
      --text: #e0e0e0;
      --muted: #6b7894;
      --flow: #00d2ff;
      --flow-glow: rgba(0, 210, 255, 0.25);
      --accent: #e94560;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: var(--bg);
      color: var(--text);
      overflow: auto;
    }

    #canvas {
      position: relative;
      width: 1100px;
      height: 780px;
      margin: 10px auto;
    }

    svg#bg,
    svg#edges {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    svg#bg { z-index: 0; }
    svg#edges { z-index: 1; pointer-events: none; }

    /* â”€â”€ Node Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .n {
      position: absolute;
      padding: 4px 10px;
      border-radius: 5px;
      font-size: 9px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1.5px solid;
      white-space: nowrap;
      z-index: 2;
      user-select: none;
    }
    .n:hover { transform: scale(1.06); z-index: 10; }

    /* â”€â”€ Node Colors (matched to hex zone) â”€ */
    /* Inner hex â€” amber/orange: rgba(217,119,6) */
    .n.domain   { background: #2d2215; border-color: #d97706; color: #fcd34d; }
    /* Middle hex â€” indigo: rgba(99,102,241) */
    .n.service  { background: #111833; border-color: #6366f1; color: #a5b4fc; }
    .n.subsvc   { background: #111833; border-color: #4f46e5; color: #a5b4fc; font-style: italic; font-size: 8px; }
    .n.port     { background: #111833; border-color: #818cf8; color: #c7d2fe; }
    /* Outer hex â€” purple: rgba(124,58,237) */
    .n.adapter  { background: #1a1030; border-color: #7c3aed; color: #c4b5fd; }
    .n.driving  { background: #1a1030; border-color: #a855f7; color: #d8b4fe; }
    .n.external { background: #1a1012; border-color: #b45050; color: #e8a0a0; }

    /* â”€â”€ Node States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .n.highlighted {
      border-color: var(--flow) !important;
      box-shadow: 0 0 14px var(--flow-glow);
      z-index: 10;
    }
    .n.trigger {
      border-color: var(--accent) !important;
      box-shadow: 0 0 18px rgba(233, 69, 96, 0.4);
      z-index: 11;
    }
    .n.dimmed { opacity: 0.12; }

    /* â”€â”€ Edges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .edge {
      fill: none;
      stroke: var(--flow);
      stroke-width: 1.8;
      opacity: 0;
    }
    .edge.visible {
      opacity: 0.7;
      stroke-dasharray: 6 4;
      animation: dash 0.8s linear infinite;
    }
    .edge.async-edge {
      stroke: var(--accent);
      stroke-width: 2.5;
      stroke-dasharray: 8 6;
    }

    .elabel {
      font-size: 8px;
      fill: var(--flow);
      opacity: 0;
      font-family: inherit;
    }
    .elabel.visible { opacity: 0.7; }
    .elabel.async-label { fill: var(--accent); }

    @keyframes dash { to { stroke-dashoffset: -20; } }

    /* â”€â”€ UI Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #info {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: var(--muted);
      z-index: 20;
      text-align: center;
    }
    #info.active { color: var(--flow); }

    #reset-btn {
      position: absolute;
      bottom: 12px;
      right: 20px;
      padding: 5px 12px;
      background: transparent;
      border: 1px solid var(--muted);
      color: var(--muted);
      border-radius: 5px;
      cursor: pointer;
      font-family: inherit;
      font-size: 10px;
      z-index: 20;
      opacity: 0;
    }
    #reset-btn.visible { opacity: 1; }
    #reset-btn:hover { border-color: var(--flow); color: var(--flow); }

    /* â”€â”€ Drag & Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .n.dragging {
      opacity: 0.8;
      z-index: 100 !important;
      cursor: grabbing;
      box-shadow: 0 0 20px rgba(0, 210, 255, 0.4);
    }

    #export-btn,
    #reset-pos-btn {
      position: absolute;
      bottom: 12px;
      padding: 5px 12px;
      background: rgba(99, 102, 241, 0.15);
      border: 1px solid rgba(99, 102, 241, 0.5);
      color: rgba(99, 102, 241, 0.8);
      border-radius: 5px;
      cursor: pointer;
      font-family: inherit;
      font-size: 10px;
      z-index: 20;
    }
    #export-btn { left: 320px; }
    #reset-pos-btn { left: 460px; }
    #export-btn:hover,
    #reset-pos-btn:hover { background: rgba(99, 102, 241, 0.3); }

    #toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 20px;
      background: rgba(5, 150, 105, 0.9);
      color: #fff;
      border-radius: 5px;
      font-family: inherit;
      font-size: 11px;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>
<div id="canvas">

  <!--
    Regular hexagons (ì •ìœ¡ê°í˜•), pointy-top, center (530, 385):
    r=340  hw=294  Outer:  530,45   824,215  824,555  530,725  236,555  236,215
    r=190  hw=165  Middle: 530,195  695,290  695,480  530,575  365,480  365,290
    r=75   hw=65   Inner:  530,310  595,348  595,423  530,460  465,423  465,348
  -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Background SVG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <svg id="bg" viewBox="0 0 1100 780">

    <!-- Hexagon layers -->
    <polygon points="530,45 824,215 824,555 530,725 236,555 236,215"
             fill="rgba(124,58,237,.03)" stroke="rgba(124,58,237,.22)" stroke-width="2"/>
    <polygon points="530,195 695,290 695,480 530,575 365,480 365,290"
             fill="rgba(99,102,241,.05)" stroke="rgba(99,102,241,.18)" stroke-width="1.5"/>
    <polygon points="530,310 595,348 595,423 530,460 465,423 465,348"
             fill="rgba(217,119,6,.06)" stroke="rgba(217,119,6,.2)" stroke-width="1.5"/>

    <!-- Layer labels -->
    <text x="530" y="37" text-anchor="middle" letter-spacing="2"
          fill="rgba(124,58,237,.4)" font-size="10" font-weight="700" font-family="inherit">INFRASTRUCTURE</text>
    <text x="530" y="187" text-anchor="middle" letter-spacing="1"
          fill="rgba(99,102,241,.35)" font-size="9" font-weight="600" font-family="inherit">APPLICATION</text>
    <text x="530" y="303" text-anchor="middle"
          fill="rgba(217,119,6,.4)" font-size="8" font-weight="600" font-family="inherit">DOMAIN</text>

    <!-- Side labels -->
    <text x="208" y="385" text-anchor="middle" transform="rotate(-90,208,385)"
          fill="rgba(96,165,250,.35)" font-size="10" font-weight="700" font-family="inherit">DRIVING</text>
    <text x="852" y="385" text-anchor="middle" transform="rotate(90,852,385)"
          fill="rgba(168,85,247,.35)" font-size="10" font-weight="700" font-family="inherit">DRIVEN</text>

    <!-- Adapter type labels -->
    <text x="225" y="220" fill="rgba(96,165,250,.4)" font-size="8" font-family="inherit" font-weight="600">HTTP Â· FastAPI :8001</text>
    <text x="318" y="578" fill="rgba(96,165,250,.4)" font-size="8" font-family="inherit" font-weight="600">Queue Consumer</text>

    <!-- â”€â”€ Legend â”€â”€ -->
    <rect x="15" y="728" width="290" height="47" rx="5"
          fill="rgba(15,25,50,.85)" stroke="rgba(30,58,95,.5)"/>

    <!-- Row 1 -->
    <rect x="25"  y="735" width="9" height="9" rx="2" fill="#2d2215" stroke="#d97706" stroke-width="1.5"/>
    <text x="38"  y="743" fill="#fcd34d" font-size="7.5" font-family="inherit">Domain</text>
    <rect x="110" y="735" width="9" height="9" rx="2" fill="#1a1030" stroke="#a855f7" stroke-width="1.5"/>
    <text x="123" y="743" fill="#d8b4fe" font-size="7.5" font-family="inherit">Driving Adapter</text>
    <rect x="215" y="735" width="9" height="9" rx="2" fill="#111833" stroke="#818cf8" stroke-width="1.5"/>
    <text x="228" y="743" fill="#c7d2fe" font-size="7.5" font-family="inherit">Port</text>

    <!-- Row 2 -->
    <rect x="25"  y="750" width="9" height="9" rx="2" fill="#111833" stroke="#6366f1" stroke-width="1.5"/>
    <text x="38"  y="758" fill="#a5b4fc" font-size="7.5" font-family="inherit">Service</text>
    <rect x="110" y="750" width="9" height="9" rx="2" fill="#1a1030" stroke="#7c3aed" stroke-width="1.5"/>
    <text x="123" y="758" fill="#c4b5fd" font-size="7.5" font-family="inherit">Driven Adapter</text>
    <rect x="215" y="750" width="9" height="9" rx="2" fill="#1a1012" stroke="#b45050" stroke-width="1.5"/>
    <text x="228" y="758" fill="#e8a0a0" font-size="7.5" font-family="inherit">External</text>

    <!-- Footnote -->
    <text x="25" y="770" fill="var(--muted)" font-size="6.5" font-family="inherit" font-style="italic">
      * No explicit Inbound Ports â€” service functions serve that role
    </text>
  </svg>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Edge SVG (dynamic) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <svg id="edges" viewBox="0 0 1100 780"></svg>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Info Bar â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="info">Click any module to trace its flow â€” ESC to reset</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EXTERNAL (outside outer hex) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="n external" data-id="client"    style="left:90px;  top:208px">Client (Browser)</div>
  <div class="n external" data-id="x_freeapi" style="left:690px; top:93px">Free Dict API</div>
  <div class="n external" data-id="x_openai"  style="left:805px; top:161px">OpenAI API</div>
  <div class="n external" data-id="x_stanza"  style="left:753px; top:129px">Stanza NLP</div>
  <div class="n external" data-id="x_mongo"   style="left:869px; top:261px">MongoDB</div>
  <div class="n external" data-id="x_crewai"  style="left:871px; top:470px">CrewAI</div>
  <div class="n external" data-id="x_redis"   style="left:735px; top:637px">Redis</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DRIVING (left infra ring) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="n driving" data-id="r_dict"     style="left:221px; top:239px">dictionary.py</div>
  <div class="n driving" data-id="r_vocab"    style="left:220px; top:270px">vocabulary.py</div>
  <div class="n driving" data-id="r_articles" style="left:220px; top:300px">articles.py</div>
  <div class="n driving" data-id="r_jobs"     style="left:225px; top:415px">jobs.py</div>
  <div class="n driving" data-id="r_usage"    style="left:226px; top:507px">usage.py</div>
  <div class="n driving" data-id="r_auth"     style="left:225px; top:480px">auth.py</div>
  <div class="n driving" data-id="r_health"   style="left:223px; top:439px">health.py</div>
  <div class="n driving" data-id="processor"  style="left:333px; top:611px">processor.py</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SERVICES (left app ring) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="n service" data-id="s_dict"   style="left:376px; top:251px">dictionary_service</div>
  <div class="n subsvc"  data-id="s_lemma"  style="left:365px; top:287px">lemma_extraction</div>
  <div class="n subsvc"  data-id="s_sense"  style="left:364px; top:312px">sense_selection</div>
  <div class="n service" data-id="s_submit" style="left:371px; top:473px">article_submission_svc</div>
  <div class="n service" data-id="s_auth"   style="left:351px; top:399px">auth_service</div>
  <div class="n service" data-id="s_token"  style="left:352px; top:438px">token_usage_service</div>
  <div class="n service" data-id="s_gen"    style="left:369px; top:497px">article_generation_svc</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DOMAIN (inner hex) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="n domain" data-id="d_article" style="left:458px; top:351px">Article</div>
  <div class="n domain" data-id="d_vocab"   style="left:528px; top:350px">Vocabulary</div>
  <div class="n domain" data-id="d_user"    style="left:457px; top:376px">User</div>
  <div class="n domain" data-id="d_token"   style="left:529px; top:375px">TokenUsage</div>
  <div class="n domain" data-id="d_cefr"    style="left:456px; top:401px">CEFRLevel</div>
  <div class="n domain" data-id="d_job"     style="left:529px; top:401px">JobContext</div>
  <div class="n domain" data-id="d_lang"    style="left:495px; top:326px">Language</div>
  <div class="n domain" data-id="d_errors"  style="left:503px; top:427px">Errors</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PORTS (right app ring) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="n port" data-id="p_dict"       style="left:513px; top:202px">DictionaryPort</div>
  <div class="n port" data-id="p_llm"        style="left:581px; top:252px">LLMPort</div>
  <div class="n port" data-id="p_nlp"        style="left:553px; top:228px">NLPPort</div>
  <div class="n port" data-id="p_vocab_repo" style="left:567px; top:316px">VocabularyRepository</div>
  <div class="n port" data-id="p_article"    style="left:580px; top:431px">ArticleRepository</div>
  <div class="n port" data-id="p_token"      style="left:567px; top:288px">TokenUsageRepository</div>
  <div class="n port" data-id="p_user"       style="left:570px; top:491px">UserRepository</div>
  <div class="n port" data-id="p_artgen"     style="left:565px; top:458px">ArticleGeneratorPort</div>
  <div class="n port" data-id="p_queue"      style="left:516px; top:534px">JobQueuePort</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DRIVEN ADAPTERS (right infra ring) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="n adapter" data-id="a_freeapi"       style="left:515px; top:96px">FreeDictionaryAdapter</div>
  <div class="n adapter" data-id="a_litellm"       style="left:664px; top:166px">LiteLLMAdapter</div>
  <div class="n adapter" data-id="a_stanza"        style="left:609px; top:131px">StanzaAdapter</div>
  <div class="n adapter" data-id="a_mongo_vocab"   style="left:728px; top:291px">MongoVocabRepo</div>
  <div class="n adapter" data-id="a_mongo_article" style="left:718px; top:318px">MongoArticleRepo</div>
  <div class="n adapter" data-id="a_mongo_token"   style="left:728px; top:264px">MongoTokenRepo</div>
  <div class="n adapter" data-id="a_mongo_user"    style="left:732px; top:235px">MongoUserRepo</div>
  <div class="n adapter" data-id="a_crewai"        style="left:724px; top:470px">CrewAIGenerator</div>
  <div class="n adapter" data-id="a_redis"         style="left:655px; top:592px">RedisJobQueue</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Buttons â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <button id="reset-btn" onclick="reset()">ESC Reset</button>
  <button id="export-btn" onclick="exportPositions()">ğŸ“‹ Export Positions</button>
  <button id="reset-pos-btn" onclick="resetPositions()">ğŸ”„ Reset Positions</button>

</div>
<div id="toast">Positions copied to clipboard!</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Flow Definitions â€” each node maps to its data-flow path
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const FLOWS = {

  // â”€â”€ Client â”€â”€
  client: {
    title: 'Client (Browser) â€” HTTP requests to API routes',
    steps: [
      ['client', 'r_dict',     '/dictionary'],
      ['client', 'r_vocab',    '/vocabulary'],
      ['client', 'r_articles', '/articles'],
      ['client', 'r_jobs',     '/jobs'],
      ['client', 'r_usage',    '/usage'],
      ['client', 'r_auth',     '/auth'],
      ['client', 'r_health',   '/health'],
    ],
    domains: [],
  },

  // â”€â”€ Route: Dictionary â”€â”€
  r_dict: {
    title: 'Dictionary Lookup â€” 3-step hybrid pipeline',
    steps: [
      ['r_dict',  's_dict',        'search()'],
      ['s_dict',  's_lemma',       'Step 1'],
      ['s_lemma', 'p_nlp',        'extract()'],
      ['s_lemma', 'p_llm',        'CEFR / reduced'],
      ['s_dict',  'p_dict',       'Step 2: fetch()'],
      ['s_dict',  's_sense',      'Step 3'],
      ['s_sense', 'p_dict',       'get_sense()'],
      ['s_sense', 'p_llm',        'X.Y.Z'],
      ['s_dict',  's_token',      'track'],
      ['s_token', 'p_token',      'save()'],
      ['p_dict',  'a_freeapi',    ''],
      ['p_llm',   'a_litellm',    ''],
      ['p_nlp',   'a_stanza',     ''],
      ['p_token', 'a_mongo_token', ''],
      ['a_freeapi',     'x_freeapi', ''],
      ['a_litellm',     'x_openai',  ''],
      ['a_stanza',      'x_stanza',  ''],
      ['a_mongo_token', 'x_mongo',   ''],
    ],
    domains: ['d_vocab', 'd_token', 'd_cefr', 'd_lang'],
  },

  // â”€â”€ Route: Vocabulary â”€â”€
  r_vocab: {
    title: 'Vocabulary â€” CRUD + aggregate queries',
    steps: [
      ['r_vocab',      'p_vocab_repo',  'save()/delete()/count_by_lemma()'],
      ['p_vocab_repo', 'a_mongo_vocab', ''],
      ['a_mongo_vocab', 'x_mongo',      ''],
    ],
    domains: ['d_vocab'],
  },

  // â”€â”€ Route: Articles â”€â”€
  r_articles: {
    title: 'Article Submission â€” create â†’ enqueue â†’ (async) Worker',
    steps: [
      ['r_articles', 's_submit',        'submit_generation()'],
      ['s_submit',   'p_article',       'save()'],
      ['s_submit',   'p_queue',         'enqueue()'],
      ['p_article',  'a_mongo_article', ''],
      ['p_queue',    'a_redis',         'produce (enqueue)'],
      ['a_mongo_article', 'x_mongo',    ''],
      ['a_redis',         'x_redis',    ''],
    ],
    domains: ['d_article', 'd_errors'],
    async_hint: { from: 'a_redis', to: 'processor', label: 'consume (dequeue)' },
  },

  // â”€â”€ Route: Jobs â”€â”€
  r_jobs: {
    title: 'Job Status â€” poll Redis',
    steps: [
      ['r_jobs',  'p_queue', 'get_status()'],
      ['p_queue', 'a_redis', 'GET'],
      ['a_redis', 'x_redis', ''],
    ],
    domains: ['d_job'],
  },

  // â”€â”€ Route: Usage â”€â”€
  r_usage: {
    title: 'Token Usage â€” summary & breakdown',
    steps: [
      ['r_usage', 'p_token',       'get_user_summary()'],
      ['p_token', 'a_mongo_token', ''],
      ['a_mongo_token', 'x_mongo', ''],
    ],
    domains: ['d_token'],
  },

  // â”€â”€ Route: Auth â”€â”€
  r_auth: {
    title: 'Authentication â€” register / login',
    steps: [
      ['r_auth',  's_auth',       'register()/login()'],
      ['s_auth',  'p_user',       'create()/get_by_email()'],
      ['p_user',  'a_mongo_user', ''],
      ['a_mongo_user', 'x_mongo', ''],
    ],
    domains: ['d_user'],
  },

  // â”€â”€ Route: Health â”€â”€
  r_health: {
    title: 'Health Check â€” Redis ping',
    steps: [
      ['r_health', 'p_queue', 'ping()'],
      ['p_queue',  'a_redis', 'PING'],
      ['a_redis',  'x_redis', ''],
    ],
    domains: [],
  },

  // â”€â”€ Worker: Processor â”€â”€
  processor: {
    title: 'Worker â€” dequeue â†’ CrewAI (2-5 min) â†’ save',
    steps: [
      ['processor', 'p_queue',         'dequeue()'],
      ['p_queue',   'a_redis',         'BLPOP'],
      ['a_redis',   'x_redis',         ''],
      ['processor', 's_gen',           'generate_article()'],
      ['s_gen',     'p_vocab_repo',    'find_lemmas()'],
      ['p_vocab_repo', 'a_mongo_vocab', ''],
      ['a_mongo_vocab', 'x_mongo',      ''],
      ['s_gen',     'p_artgen',        'generate()'],
      ['p_artgen',  'a_crewai',        ''],
      ['a_crewai',  'x_crewai',        'run()'],
      ['s_gen',     'p_article',       'save()'],
      ['p_article', 'a_mongo_article', ''],
      ['a_mongo_article', 'x_mongo',   ''],
      ['s_gen',     's_token',         'track_agent_usage()'],
      ['s_token',   'p_token',         'save()'],
      ['p_token',   'a_mongo_token',   ''],
      ['a_mongo_token', 'x_mongo',     ''],
    ],
    domains: ['d_article', 'd_job', 'd_cefr', 'd_token'],
  },

  // â”€â”€ Service: Dictionary â”€â”€
  s_dict: {
    title: 'Dictionary Service â€” orchestrates pipeline + fallback',
    steps: [
      ['s_dict',  's_lemma', 'Step 1'],
      ['s_dict',  's_sense', 'Step 3'],
      ['s_dict',  'p_dict',  'Step 2: fetch()'],
      ['s_dict',  'p_llm',   'fallback'],
      ['s_dict',  's_token', 'track'],
      ['s_lemma', 'p_nlp',   'extract()'],
      ['s_lemma', 'p_llm',   'reduced'],
      ['s_sense', 'p_dict',  'get_sense()'],
      ['s_sense', 'p_llm',   'X.Y.Z'],
    ],
    domains: ['d_vocab', 'd_cefr', 'd_lang'],
  },

  // â”€â”€ Service: Submission â”€â”€
  s_submit: {
    title: 'Submission Service â€” duplicate check â†’ create â†’ enqueue',
    steps: [
      ['s_submit', 'p_article', 'save()/find_duplicate()'],
      ['s_submit', 'p_queue',   'enqueue()/update_status()'],
    ],
    domains: ['d_article', 'd_errors'],
  },

  // â”€â”€ Service: Generation â”€â”€
  s_gen: {
    title: 'Generation Service â€” vocab â†’ generate â†’ save â†’ track',
    steps: [
      ['s_gen', 'p_vocab_repo', 'find_lemmas()'],
      ['s_gen', 'p_artgen',     'generate()'],
      ['s_gen', 'p_article',    'save()'],
      ['s_gen', 's_token',      'track_agent_usage()'],
    ],
    domains: ['d_article', 'd_cefr'],
  },

  // â”€â”€ Service: Token Usage â”€â”€
  s_token: {
    title: 'Token Service â€” LLMCallResult â†’ TokenUsage â†’ persist',
    steps: [
      ['s_token', 'p_token', 'save()'],
      ['s_token', 'p_llm',   'estimate_cost()'],
    ],
    domains: ['d_token'],
  },
};

// â”€â”€ NODE_DOMAINS: per-node domain overrides for reverse flow â”€â”€
// Prevents reverse flow from merging domains of ALL flows a node appears in.
// Nodes NOT listed here fall back to the existing union-of-flows logic.
const NODE_DOMAINS = {
  // Ports
  p_token:      ['d_token'],
  p_vocab_repo: ['d_vocab'],
  p_article:    ['d_article', 'd_errors'],
  p_queue:      ['d_job'],
  p_artgen:     ['d_article', 'd_cefr'],
  p_nlp:        ['d_vocab', 'd_lang'],
  p_dict:       ['d_vocab', 'd_lang'],
  p_llm:        ['d_vocab', 'd_cefr', 'd_token', 'd_lang'],
  p_user:       ['d_user'],
  // Adapters
  a_mongo_token:   ['d_token'],
  a_mongo_vocab:   ['d_vocab'],
  a_mongo_article: ['d_article'],
  a_mongo_user:    ['d_user'],
  a_redis:         ['d_job'],
  a_freeapi:       ['d_vocab', 'd_lang'],
  a_litellm:       [],
  a_stanza:        ['d_vocab', 'd_lang'],
  a_crewai:        ['d_article', 'd_cefr'],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Interactive Logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const allNodes = document.querySelectorAll('.n');
const svg      = document.getElementById('edges');
const info     = document.getElementById('info');
const resetBtn = document.getElementById('reset-btn');

let active = null;

function el(id) {
  return document.querySelector(`.n[data-id="${id}"]`);
}

function center(id) {
  const n = el(id);
  if (!n) return null;
  const c = document.getElementById('canvas').getBoundingClientRect();
  const r = n.getBoundingClientRect();
  return {
    x: r.left - c.left + r.width / 2,
    y: r.top  - c.top  + r.height / 2,
  };
}

function drawLine(a, b, label, delay, isAsync) {
  const p1 = center(a);
  const p2 = center(b);
  if (!p1 || !p2) return;

  const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  l.setAttribute('x1', p1.x);
  l.setAttribute('y1', p1.y);
  l.setAttribute('x2', p2.x);
  l.setAttribute('y2', p2.y);
  l.setAttribute('class', 'edge' + (isAsync ? ' async-edge' : ''));
  svg.appendChild(l);

  if (label) {
    const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    t.setAttribute('x', (p1.x + p2.x) / 2);
    t.setAttribute('y', (p1.y + p2.y) / 2 - 6);
    t.setAttribute('text-anchor', 'middle');
    t.setAttribute('class', 'elabel' + (isAsync ? ' async-label' : ''));
    t.textContent = label;
    svg.appendChild(t);
  }

  setTimeout(() => {
    l.classList.add('visible');
    if (label) {
      const ls = svg.querySelectorAll('text.elabel');
      ls[ls.length - 1].classList.add('visible');
    }
  }, delay);
}

function drawLabel(a, b, label, delay) {
  const p1 = center(a);
  const p2 = center(b);
  if (!p1 || !p2 || !label) return;

  const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  t.setAttribute('x', (p1.x + p2.x) / 2);
  t.setAttribute('y', (p1.y + p2.y) / 2 + 6);
  t.setAttribute('text-anchor', 'middle');
  t.setAttribute('class', 'elabel');
  t.textContent = label;
  svg.appendChild(t);

  setTimeout(() => t.classList.add('visible'), delay);
}

function show(flow, triggerId) {
  reset();
  active = true;

  // Collect involved node IDs
  const inv = new Set();
  if (triggerId) inv.add(triggerId);
  flow.steps.forEach(s => { inv.add(s[0]); inv.add(s[1]); });
  if (flow.domains) flow.domains.forEach(d => inv.add(d));
  if (flow.async_hint) {
    inv.add(flow.async_hint.from);
    inv.add(flow.async_hint.to);
  }

  // Highlight / dim nodes
  allNodes.forEach(n => {
    const id = n.dataset.id;
    if (inv.has(id)) {
      n.classList.add('highlighted');
      n.classList.remove('dimmed');
    } else {
      n.classList.add('dimmed');
      n.classList.remove('highlighted');
    }
  });

  // Mark trigger node
  if (triggerId) {
    const t = el(triggerId);
    if (t) {
      t.classList.remove('highlighted');
      t.classList.add('trigger');
    }
  }

  // Draw edges with sequential animation (deduplicate same-path edges)
  const drawn = new Set();
  let delay = 0;
  flow.steps.forEach((s) => {
    const key = s[0] + 'â†’' + s[1];
    const label = drawn.has(key) ? '' : s[2];
    if (!drawn.has(key)) {
      drawLine(s[0], s[1], label, delay * 100, false);
      drawn.add(key);
    } else if (s[2]) {
      // Duplicate path but has a new label â€” draw label only
      drawLabel(s[0], s[1], s[2], delay * 100);
    }
    delay++;
  });

  // Async hint edge
  if (flow.async_hint) {
    const h = flow.async_hint;
    drawLine(h.from, h.to, h.label, flow.steps.length * 100, true);
  }

  info.textContent = flow.title;
  info.classList.add('active');
  resetBtn.classList.add('visible');
}

function reset() {
  active = null;
  allNodes.forEach(n => n.classList.remove('highlighted', 'dimmed', 'trigger'));
  svg.innerHTML = '';
  info.textContent = 'Click any module to trace its flow â€” ESC to reset';
  info.classList.remove('active');
  resetBtn.classList.remove('visible');
}

// Build reverse lookup â€” for nodes without their own FLOW
function buildReverseFlow(nodeId) {
  const steps = [];
  for (const [, flow] of Object.entries(FLOWS)) {
    for (const step of flow.steps) {
      if (step[0] === nodeId || step[1] === nodeId) {
        steps.push(step);
      }
    }
  }
  if (steps.length === 0) return null;

  let domains;
  if (NODE_DOMAINS[nodeId]) {
    domains = NODE_DOMAINS[nodeId];
  } else {
    const domainSet = new Set();
    for (const [, flow] of Object.entries(FLOWS)) {
      if (flow.domains && flow.steps.some(s => s[0] === nodeId || s[1] === nodeId)) {
        flow.domains.forEach(d => domainSet.add(d));
      }
    }
    domains = [...domainSet];
  }

  const label = el(nodeId)?.textContent || nodeId;
  return { title: `${label} â€” all connections`, steps, domains };
}

// â”€â”€ Event Listeners â”€â”€
allNodes.forEach(n => {
  n.addEventListener('click', e => {
    e.stopPropagation();
    const id = n.dataset.id;
    const flow = FLOWS[id] || buildReverseFlow(id);
    if (flow) show(flow, id);
  });
});

document.addEventListener('click', () => { if (active) reset(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') reset(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Drag & Drop + localStorage Persistence
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORAGE_KEY = 'opad-hex-positions';

// Restore saved positions on load
function restorePositions() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return;
  try {
    const positions = JSON.parse(saved);
    allNodes.forEach(n => {
      const id = n.dataset.id;
      if (positions[id]) {
        n.style.left = positions[id].left;
        n.style.top  = positions[id].top;
      }
    });
  } catch (e) { /* ignore corrupt data */ }
}

// Save all positions to localStorage
function savePositions() {
  const positions = {};
  allNodes.forEach(n => {
    positions[n.dataset.id] = {
      left: n.style.left,
      top:  n.style.top,
    };
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(positions));
}

restorePositions();

const DRAG_DELAY = 500; // ms â€” long-press threshold

let dragTarget = null;
let dragOffsetX = 0;
let dragOffsetY = 0;
let dragMoved = false;
let dragReady = false; // true after long-press threshold
let dragTimer = null;
let pendingNode = null;

allNodes.forEach(n => {
  n.addEventListener('mousedown', e => {
    if (e.button !== 0) return;
    e.preventDefault();

    pendingNode = n;
    dragMoved = false;
    dragReady = false;

    const rect = n.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    // Start drag only after holding for DRAG_DELAY ms
    dragTimer = setTimeout(() => {
      dragTarget = pendingNode;
      dragReady = true;
      dragTarget.classList.add('dragging');
    }, DRAG_DELAY);
  });
});

document.addEventListener('mousemove', e => {
  if (!dragReady || !dragTarget) return;
  dragMoved = true;

  const canvasRect = document.getElementById('canvas').getBoundingClientRect();
  const newLeft = e.clientX - canvasRect.left - dragOffsetX;
  const newTop  = e.clientY - canvasRect.top  - dragOffsetY;

  dragTarget.style.left = Math.round(newLeft) + 'px';
  dragTarget.style.top  = Math.round(newTop)  + 'px';
});

document.addEventListener('mouseup', () => {
  // Cancel pending long-press if released early
  if (dragTimer) {
    clearTimeout(dragTimer);
    dragTimer = null;
  }

  if (dragTarget) {
    dragTarget.classList.remove('dragging');

    if (dragMoved) {
      savePositions();
      const suppress = ev => { ev.stopPropagation(); };
      dragTarget.addEventListener('click', suppress, { capture: true, once: true });
    }
  }

  dragTarget = null;
  pendingNode = null;
  dragReady = false;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Export Positions â€” copy current node positions to clipboard
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function resetPositions() {
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

function exportPositions() {
  const lines = [];
  const groups = {
    driving:  '<!-- DRIVING -->',
    service:  '<!-- SERVICES -->',
    subsvc:   '<!-- SERVICES -->',
    domain:   '<!-- DOMAIN -->',
    port:     '<!-- PORTS -->',
    adapter:  '<!-- ADAPTERS -->',
    external: '<!-- EXTERNAL -->',
  };

  // Group nodes by type
  const grouped = {};
  allNodes.forEach(n => {
    const cls = [...n.classList].find(c => groups[c]);
    const group = groups[cls] || '<!-- OTHER -->';
    if (!grouped[group]) grouped[group] = [];
    grouped[group].push(n);
  });

  for (const [header, nodes] of Object.entries(grouped)) {
    lines.push(header);
    nodes.forEach(n => {
      const id   = n.dataset.id;
      const cls  = [...n.classList].find(c => c !== 'n' && c !== 'dragging' && c !== 'highlighted' && c !== 'dimmed' && c !== 'trigger');
      const left = n.style.left;
      const top  = n.style.top;
      const text = n.textContent;
      lines.push(`  <div class="n ${cls}" data-id="${id}" style="left:${left}; top:${top}">${text}</div>`);
    });
    lines.push('');
  }

  const output = lines.join('\n');
  navigator.clipboard.writeText(output).then(() => {
    const toast = document.getElementById('toast');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  });
}
</script>
</body>
</html>
